<!DOCTYPE html>
<html>
<head>
  <title>Three.js y TensorFlow.js con MediaPipe</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    #label { position: absolute; top: 10px; left: 10px; color: white; background: rgba(0, 0, 0, 0.5); padding: 5px 10px; border-radius: 4px; font-size: 16px; display: none; }
    #modelInfo { position: absolute; bottom: 10px; left: 10px; color: white; background: rgba(0, 0, 0, 0.5); padding: 5px 10px; border-radius: 4px; font-size: 16px; display: none; }
  </style>
</head>
<body>
  <div id="label">Cara reconocida</div>
  <div id="modelInfo">Información del modelo</div>
  <video id="input_video" width="1280" height="720" style="display: none;"></video>
  <div id="threejs-container"></div>
  <script src="https://cdn.rawgit.com/mrdoob/three.js/r128/examples/js/loaders/OBJLoader.js"></script>
  <script>
    const videoElement = document.getElementById('input_video');
    const labelElement = document.getElementById('label');
    const modelInfoElement = document.getElementById('modelInfo');

    let cameraUtils = null;

    const faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.8,
      minTrackingConfidence: 0.8
    });

    faceMesh.onResults(onResults);

    startCamera();

    function startCamera() {
      if (!cameraUtils) {
        cameraUtils = new Camera(videoElement, {
          onFrame: async () => {
            await faceMesh.send({ image: videoElement });
          },
          width: 1280,
          height: 720
        });
      }
      cameraUtils.start()
        .then(() => {
          console.log('Cámara iniciada');
        })
        .catch((error) => {
          console.error('Error al acceder a la cámara:', error);
          alert('No se pudo acceder a la cámara. Verifica los permisos y asegúrate de que no esté siendo utilizada por otra aplicación.');
        });
    }

    let scene, camera, renderer, hatModel;
    let headBoundingBox = new THREE.Box3();
    let hatBoundingBox = new THREE.Box3();

    function initThreeJS() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('threejs-container').appendChild(renderer.domElement);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, 1, 1).normalize();
      scene.add(light);

      const loader = new THREE.OBJLoader();
      loader.load('https://nicolascumbej.github.io/arexperience/tmp2h0xvw1a.obj', function (object) {
        hatModel = object;
        hatModel.scale.set(0.5, 0.5, 0.5);
        hatModel.visible = false;
        scene.add(hatModel);
      });

      camera.position.z = 5;
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    function onResults(results) {
      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];

        // Usar más puntos de referencia para mejorar la precisión
        const noseTip = landmarks[1];
        const leftEar = landmarks[234];
        const rightEar = landmarks[454];
        const foreheadCenter = landmarks[10];
        const chin = landmarks[152];

        // Calcular la caja delimitadora de la cabeza
        headBoundingBox.setFromPoints([
          new THREE.Vector3(noseTip.x, noseTip.y, noseTip.z),
          new THREE.Vector3(leftEar.x, leftEar.y, leftEar.z),
          new THREE.Vector3(rightEar.x, rightEar.y, rightEar.z),
          new THREE.Vector3(foreheadCenter.x, foreheadCenter.y, foreheadCenter.z),
          new THREE.Vector3(chin.x, chin.y, chin.z)
        ]);

        // Calcular el centro de la cabeza y el tamaño
        const headCenter = headBoundingBox.getCenter(new THREE.Vector3());
        const headSize = headBoundingBox.getSize(new THREE.Vector3());

        // Ajustar la posición y la escala de la gorra
        hatModel.position.set(headCenter.x, headCenter.y + headSize.y * 0.5, headCenter.z);
        hatModel.scale.set(headSize.x * 0.5, headSize.y * 0.5, headSize.z * 0.5);
        hatModel.visible = true;

        // Detectar colisión y ajustar la gorra si es necesario
        hatBoundingBox.setFromObject(hatModel);
        if (hatBoundingBox.intersectsBox(headBoundingBox)) {
          hatModel.position.y += headSize.y * 0.1;
        }

        labelElement.innerHTML = `Anchura de la cabeza: ${headSize.x.toFixed(2)}<br>Altura de la cabeza: ${headSize.y.toFixed(2)}`;
        labelElement.style.display = 'block';
        modelInfoElement.textContent = 'Modelo cargado correctamente';
        modelInfoElement.style.display = 'block';
      } else {
        hatModel.visible = false;
        labelElement.style.display = 'none';
        modelInfoElement.style.display = 'none';
      }
    }

    initThreeJS();
    animate();
  </script>
</body>
</html>
