<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AR.js con A-Frame y MediaPipe</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">

    <a-scene embedded arjs>
        <a-assets>
            <!-- Asegúrate de que el archivo glTF de la gorra está en la ruta correcta -->
            <a-asset-item id="hatModel" src="./hat.glb"></a-asset-item>
        </a-assets>

        <a-entity id="hat" position="0 0 0" scale="0.01 0.01 0.01" rotation="0 0 0" visible="false" gltf-model="#hatModel"></a-entity>
    </a-scene>

    <div id="modelInfo" style="position: absolute; top: 10px; left: 10px; color: white; background-color: black; padding: 10px;"></div>
    
    <script type="module">
        import { Holistic, POSE_LANDMARKS, FACE_LANDMARKS, HAND_LANDMARKS } from 'https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.4';
        import { Camera } from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils';

        const videoElement = document.createElement('video');
        document.body.appendChild(videoElement);
        videoElement.style.display = 'none'; // Ocultar el elemento de video

        const hatEntity = document.querySelector('#hat');
        const modelInfoDiv = document.querySelector('#modelInfo');

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
            videoElement.play();

            return new Promise((resolve) => {
                videoElement.onloadedmetadata = () => {
                    resolve(videoElement);
                };
            });
        }

        setupCamera().then(video => {
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await holistic.send({ image: videoElement });
                },
                width: 640,
                height: 480
            });
            camera.start();
        });

        const holistic = new Holistic({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`
        });

        holistic.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            smoothSegmentation: true,
            refineFaceLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        holistic.onResults(onResults);

        function onResults(results) {
            if (results.faceLandmarks) {
                const landmarks = results.faceLandmarks;
                const headPosition = calculateHeadPosition(landmarks);

                // Posicionar la gorra
                hatEntity.setAttribute('position', `${headPosition.x} ${headPosition.y} ${headPosition.z}`);
                hatEntity.setAttribute('scale', `${headPosition.scaleX} ${headPosition.scaleY} ${headPosition.scaleZ}`);
                hatEntity.object3D.visible = true;

                modelInfoDiv.innerHTML = `Cara detectada. Ancho: ${headPosition.width}, Alto: ${headPosition.height}, Profundidad: ${headPosition.depth}`;
            } else {
                hatEntity.object3D.visible = false;
                modelInfoDiv.innerHTML = 'No se detectó ninguna cara';
            }
        }

        function calculateHeadPosition(landmarks) {
            const leftEar = landmarks[234];
            const rightEar = landmarks[454];
            const noseTip = landmarks[1];
            const chin = landmarks[152];
            const forehead = landmarks[10];

            const headWidth = Math.hypot(rightEar.x - leftEar.x, rightEar.y - leftEar.y, rightEar.z - leftEar.z);
            const headHeight = Math.hypot(forehead.y - chin.y, forehead.z - chin.z);
            const depth = Math.abs(noseTip.z - (leftEar.z + rightEar.z) / 2);

            const scale = headWidth * 1.5;

            const xPos = (leftEar.x + rightEar.x) / 2;
            const yPos = (forehead.y + chin.y) / 2;
            const zPos = (leftEar.z + rightEar.z) / 2 - depth;

            return {
                x: xPos,
                y: yPos,
                z: -zPos,
                scaleX: scale,
                scaleY: scale,
                scaleZ: scale,
                width: headWidth,
                height: headHeight,
                depth: depth
            };
        }
    </script>
</body>
</html>
