<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AR Gorra Ajustable</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://rawgit.com/mayognaise/aframe-face-tracking/master/dist/aframe-face-tracking.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #label, #model-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: white;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 5px;
      border-radius: 5px;
      display: none;
    }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 5px;
      color: white;
    }
  </style>
</head>
<body>
  <a-scene embedded arjs='trackingMethod: best; sourceType: webcam;' face-tracking>
    <a-entity id="hat" gltf-model="https://nicolascumbej.github.io/arexperience/tmp2h0xvw1a.obj" position="0 0 0" rotation="0 0 0" scale="0.1 0.1 0.1" visible="false"></a-entity>
    <a-camera-static></a-camera-static>
  </a-scene>
  <div id="label"></div>
  <div id="model-info"></div>
  <div id="controls">
    <label>Ajuste Vertical: <input type="range" id="verticalAdjust" min="-0.5" max="0.5" step="0.01" value="0"></label><br>
    <label>Ajuste Horizontal: <input type="range" id="horizontalAdjust" min="-0.5" max="0.5" step="0.01" value="0"></label><br>
    <label>Ajuste de Tama침o: <input type="range" id="sizeAdjust" min="0.5" max="2" step="0.1" value="1"></label>
  </div>
  <script>
    const hat = document.getElementById('hat');
    const labelElement = document.getElementById('label');
    const modelInfoElement = document.getElementById('model-info');
    const verticalAdjust = document.getElementById('verticalAdjust');
    const horizontalAdjust = document.getElementById('horizontalAdjust');
    const sizeAdjust = document.getElementById('sizeAdjust');

    let lastUpdateTime = 0;
    const updateInterval = 100; // ms

    document.querySelector('a-scene').addEventListener('face-detected', (event) => {
      const currentTime = Date.now();
      if (currentTime - lastUpdateTime > updateInterval) {
        const { face } = event.detail;
        updateHatPosition(face);
        lastUpdateTime = currentTime;
      }
    });

    function updateHatPosition(face) {
      const { boundingBox, landmarks } = face;
      if (boundingBox && landmarks) {
        const [leftEye, rightEye, nose, mouth] = landmarks;
        const headWidth = rightEye.x - leftEye.x;
        const headHeight = mouth.y - nose.y;
        const position = {
          x: (leftEye.x + rightEye.x) / 2 + parseFloat(horizontalAdjust.value),
          y: nose.y - headHeight * 0.5 + parseFloat(verticalAdjust.value),
          z: -0.2 - Math.abs(parseFloat(verticalAdjust.value)) // Ajustar profundidad basado en el ajuste vertical
        };
        const baseScale = parseFloat(sizeAdjust.value);
        const scale = {
          x: headWidth * baseScale,
          y: headHeight * 1.5 * baseScale,
          z: headWidth * baseScale
        };
        const dx = rightEye.x - leftEye.x;
        const dy = rightEye.y - leftEye.y;
        const angleZ = Math.atan2(dy, dx) * (180 / Math.PI);
        const rotation = {
          x: 0,
          y: 180,
          z: angleZ
        };

        hat.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
        hat.setAttribute('scale', `${scale.x} ${scale.y} ${scale.z}`);
        hat.setAttribute('rotation', `${rotation.x} ${rotation.y} ${rotation.z}`);
        hat.setAttribute('visible', true);

        labelElement.innerHTML = `Posici칩n de la cabeza:<br>X: ${position.x.toFixed(2)}, Y: ${position.y.toFixed(2)}, Z: ${position.z.toFixed(2)}<br>Anchura de la cabeza: ${headWidth.toFixed(2)}<br>Altura de la cabeza: ${headHeight.toFixed(2)}`;
        modelInfoElement.innerHTML = `Modelo cargado. Posici칩n: (${position.x.toFixed(2)}, ${position.y.toFixed(2)}, ${position.z.toFixed(2)})`;
        labelElement.style.display = 'block';
        modelInfoElement.style.display = 'block';
      } else {
        labelElement.style.display = 'none';
        modelInfoElement.style.display = 'none';
        hat.setAttribute('visible', false);
      }
    }

    // Actualizar la posici칩n del sombrero cuando se cambian los controles
    verticalAdjust.addEventListener('input', () => updateHatPosition(face));
    horizontalAdjust.addEventListener('input', () => updateHatPosition(face));
    sizeAdjust.addEventListener('input', () => updateHatPosition(face));
  </script>
</body>
</html>
