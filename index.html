<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probador Virtual AR - Gorra</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <style>
        #arScene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #controls { 
            position: absolute; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.7); color: white; 
            padding: 10px; border-radius: 5px; 
            display: none;
        }
        #startButton {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px 20px; font-size: 18px;
            background: #4CAF50; color: white;
            border: none; border-radius: 5px;
            cursor: pointer;
        }
        #loadingMessage {
            position: absolute; top: 60%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px; color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px; border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <a-scene id="arScene" vr-mode-ui="enabled: false" embedded>
        <a-assets>
            <a-asset-item id="hat-model" src="https://nicolascumbej.github.io/arexperience/tmp2h0xvw1a.obj"></a-asset-item>
        </a-assets>

        <a-entity id="hat" obj-model="obj: #hat-model" position="0 0 -0.5" scale="0.1 0.1 0.1" visible="false"></a-entity>
        
        <a-entity camera look-controls></a-entity>
    </a-scene>

    <div id="controls">
        <label>Ajuste Vertical: <input type="range" id="verticalAdjust" min="-50" max="50" value="0"></label><br>
        <label>Ajuste Horizontal: <input type="range" id="horizontalAdjust" min="-50" max="50" value="0"></label><br>
        <label>Tamaño: <input type="range" id="sizeAdjust" min="50" max="150" value="100"></label>
    </div>
    <button id="startButton">Iniciar Experiencia AR</button>
    <div id="loadingMessage">Cargando... Por favor, espere.</div>

    <script>
        let faceDetector;
        const video = document.createElement('video');
        const hat = document.querySelector('#hat');

        async function loadFaceDetector() {
            try {
                return await blazeface.load();
            } catch (error) {
                console.error('Error al cargar el modelo de detección facial:', error);
                alert('No se pudo cargar el modelo de detección facial. Por favor, recargue la página e inténtelo de nuevo.');
                throw error;
            }
        }

        async function init() {
            document.getElementById('loadingMessage').style.display = 'block';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.play();

                faceDetector = await loadFaceDetector();

                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('controls').style.display = 'block';
                hat.setAttribute('visible', 'true');

                animate();
            } catch (error) {
                console.error('Error durante la inicialización:', error);
                document.getElementById('loadingMessage').textContent = 'Error al iniciar. Por favor, recargue e inténtelo de nuevo.';
            }
        }

        async function animate() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    const faces = await faceDetector.estimateFaces(video, false);
                    if (faces.length > 0) {
                        updateHatPosition(faces[0]);
                    }
                } catch (error) {
                    console.error('Error al estimar los puntos faciales:', error);
                }
            }
            requestAnimationFrame(animate);
        }

        function updateHatPosition(face) {
            const nose = face.landmarks[2];
            const leftEye = face.landmarks[1];
            const rightEye = face.landmarks[0];

            const centerX = -(nose[0] - video.videoWidth / 2) / (video.videoWidth / 2);
            const centerY = (nose[1] - video.videoHeight / 2) / (video.videoHeight / 2);
            const centerZ = -0.5;

            const scale = Math.abs(leftEye[0] - rightEye[0]) / video.videoWidth;

            const verticalAdjust = document.getElementById('verticalAdjust').value / 100;
            const horizontalAdjust = document.getElementById('horizontalAdjust').value / 100;
            const sizeAdjust = document.getElementById('sizeAdjust').value / 100;

            hat.setAttribute('position', `${centerX + horizontalAdjust} ${-centerY + verticalAdjust} ${centerZ}`);
            hat.setAttribute('scale', `${0.1 * scale * sizeAdjust} ${0.1 * scale * sizeAdjust} ${0.1 * scale * sizeAdjust}`);

            const dx = rightEye[0] - leftEye[0];
            const dy = rightEye[1] - leftEye[1];
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            hat.setAttribute('rotation', `0 0 ${-angle}`);
        }

        document.getElementById('startButton').addEventListener('click', () => {
            init();
            document.getElementById('startButton').style.display = 'none';
        });

        ['verticalAdjust', 'horizontalAdjust', 'sizeAdjust'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                if (faceDetector) {
                    animate();
                }
            });
        });
    </script>
</body>
</html>
